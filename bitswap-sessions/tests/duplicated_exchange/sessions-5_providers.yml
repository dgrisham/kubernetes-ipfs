name: One node downloads directory from 5 other nodes
config:
    nodes: 6
    selector: app=go-ipfs-bitswap-sessions
    times: 1
    expected:
        successes: 0
        failures: 0
        timeouts: 0

steps:

    # Set up topology
    # ---------------

    ### Disconnect all

  - name: Remove all bootstrap peers from every node
    on_node: 1
    end_node: 6
    cmd: for node in $(ipfs bootstrap list); do ipfs bootstrap rm $node; done;
    timeout: 0

  - name: Remove all normal peers from every node
    on_node: 1
    end_node: 6
    cmd: for node in $(ipfs swarm peers); do ipfs swarm disconnect $node; done;
    timeout: 0

    ### Get LAN addrs

  - name: Get connection info from node 1
    on_node: 1
    cmd: ipfs id -f "<addrs>" | grep 172
    outputs:
    - line: 0
      save_to: LANADDR1

  - name: Get connection info from node 2
    on_node: 2
    cmd: ipfs id -f "<addrs>" | grep 172
    outputs:
    - line: 0
      save_to: LANADDR2

  - name: Get connection info from node 3
    on_node: 3
    cmd: ipfs id -f "<addrs>" | grep 172
    outputs:
    - line: 0
      save_to: LANADDR3

  - name: Get connection info from node 4
    on_node: 4
    cmd: ipfs id -f "<addrs>" | grep 172
    outputs:
    - line: 0
      save_to: LANADDR4

  - name: Get connection info from node 5
    on_node: 5
    cmd: ipfs id -f "<addrs>" | grep 172
    outputs:
    - line: 0
      save_to: LANADDR5

    ### Establish connections between all peers

  - name: Connect to node 1 from every other node
    on_node: 2
    end_node: 6
    inputs:
      - LANADDR1
    cmd: ipfs swarm connect $LANADDR1

  - name: Connect to node 2 from every other node
    on_node: 3
    end_node: 6
    inputs:
      - LANADDR2
    cmd: ipfs swarm connect $LANADDR2

  - name: Connect to node 3 from every other node
    on_node: 4
    end_node: 6
    inputs:
      - LANADDR3
    cmd: ipfs swarm connect $LANADDR3

  - name: Connect to node 4 from every other node
    on_node: 5
    end_node: 6
    inputs:
      - LANADDR4
    cmd: ipfs swarm connect $LANADDR4

  - name: Connect to node 5 from every other node
    on_node: 6
    inputs:
      - LANADDR5
    cmd: ipfs swarm connect $LANADDR5

    # Test
    # ----

    ### Add directory with a bunch of small files

  - name: Node 1 add directory with 100 files
    on_node: 1
    cmd: "export DIR=/tmp/ipfs
       && rm -rf $DIR && mkdir $DIR
       && for i in {1..100}; do
            head -c 100 /dev/urandom | base64 > $DIR/file$i.txt;
          done
       && ipfs add -rq $DIR | tail -n1"
    timeout: 0
    outputs:
      - line: 0
        save_to: HASH

   ### Two nodes each download 1/2 of files

  - name: Nodes 2-5 download directory
    on_node: 2
    end_node: 5
    inputs:
      - HASH
    cmd: "ipfs pin add $HASH"

  - name: Node 6 sleep for a bit, then download directory
    on_node: 6
    inputs:
      - HASH
    cmd: "sleep 15 && ipfs pin add $HASH"

